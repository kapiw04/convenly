# Database Documentation

## Overview

### Attendance Table

**Name:** `attendance`

#### Columns

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `user_id` | UUID | FOREIGN KEY REFERENCES users(user_id) ON DELETE CASCADE, PRIMARY KEY | User identifier |
| `event_id` | UUID | FOREIGN KEY REFERENCES events(event_id) ON DELETE CASCADE, PRIMARY KEY | Event identifier |


---

### Sessions Tablestore. Database schema is managed using migrations located in `internal/infra/db/migrations/`.

## Connection Details

### Default Configuration
- **Host:** localhost (or `db` when using Docker)
- **Port:** 5432
- **User:** `POSTGRES_USER` (environment variable)
- **Password:** `POSTGRES_PASSWORD` (environment variable)
- **Database:** `POSTGRES_DB` (environment variable)
- **SSL Mode:** disabled

### Connection String
```
postgres://user:password@localhost:5432/database_name?sslmode=disable
```

---

## ERD Diagram
![erd-diagram](../assets/docs/convenly-db.png)

## Schema

### Users Table

**Name:** `users`

#### Columns

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `user_id` | UUID | PRIMARY KEY | Unique user identifier |
| `email` | TEXT | NOT NULL | User's email address (stored in lowercase) |
| `password_hash` | TEXT | NOT NULL | Hashed user password using bcrypt |
| `name` | TEXT | NOT NULL | User's full name |
| `role` | SMALLINT | FOREIGN KEY REFERENCES roles(role_id) | User's role identifier |
| `created_at` | TIMESTAMPTZ | NOT NULL, DEFAULT now() | Account creation timestamp |


### Role Table
**Name:** `roles`

#### Columns
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `role_id` | SMALLINT | PRIMARY KEY | Unique role identifier (integer) |
| `name` | TEXT | UNIQUE, NOT NULL | Name of the role (e.g., Host, Attendee) |

**Pre-populated Roles:**
| role_id | name |
|---------|------|
| 0 | Attendee |
| 1 | Host |

---

### Events Table

**Name:** `events`

#### Columns

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `event_id` | UUID | PRIMARY KEY | Unique event identifier |
| `name` | TEXT | UNIQUE | Event name |
| `description` | TEXT | | Event description |
| `date` | DATE | | Event date |
| `latitude` | DECIMAL | | Latitude coordinate of the event location |
| `longitude` | DECIMAL | | Longitude coordinate of the event location |
| `fee` | DECIMAL | | Event entrance fee |
| `organizer_id` | UUID | FOREIGN KEY REFERENCES users(user_id) ON DELETE CASCADE | User ID of the event organizer |

---

### Attendances Table

**Name:** `attendances`

#### Columns

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `event_id` | UUID | FOREIGN KEY REFERENCES events(event_id), PRIMARY KEY | Event identifier |
| `user_id` | UUID | FOREIGN KEY REFERENCES users(user_id), PRIMARY KEY | User identifier |


---

### Tags Table

**Name:** `tags`

#### Columns

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `tag_id` | BIGINT | PRIMARY KEY, GENERATED ALWAYS AS IDENTITY | Unique tag identifier |
| `name` | TEXT | UNIQUE, NOT NULL | Tag name |

---

### Event Tags Table

**Name:** `event_tag`

#### Columns

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `event_id` | UUID | FOREIGN KEY REFERENCES events(event_id), PRIMARY KEY | Event identifier |
| `tag_id` | BIGINT | FOREIGN KEY REFERENCES tags(tag_id), PRIMARY KEY | Tag identifier |

---

### Sessions Table

**Name:** `sessions`

#### Columns
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `session_id` | TEXT | PRIMARY KEY | Base64 URL-safe session token generated by the application |
| `user_id` | UUID | FOREIGN KEY REFERENCES users(user_id) ON DELETE CASCADE | Owner of the session |


## Migrations

Migrations are located in `internal/infra/db/migrations/` and use the naming convention:
```
XXXXXX_description.{up,down}.sql
```